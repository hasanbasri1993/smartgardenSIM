
#include <GPRS_Shield_Arduino.h>
#include <SoftwareSerial.h>
#include <Wire.h>
int sensor_temp = A0;
int value_temp;
int sensor_light = A1;
int value_light;
int sensor_humid = A2;
int value_humid;
#define PIN_TX    2
#define PIN_RX    3
//make sure that the baud rate of SIM900 is 9600!
//you can use the AT Command(AT+IPR=9600) to set it through SerialDebug
#define BAUDRATE  9600

char buffer[512];
GPRS gprs(PIN_TX, PIN_RX, BAUDRATE);
void setup() {
  Serial.begin(9600);
  // use DHCP
  while (!gprs.init()) {
    delay(1000);
    Serial.print("init error\r\n");
  }
  Serial.println("init Sukses");
  delay(3000);
  // attempt DHCP
  Serial.println("attempt DHCP ");
  while (!gprs.join(F("internet"))) {
    Serial.println("gprs join network error");
    delay(2000);
  }


}

void loop() {

  // successful DHCP
  Serial.print("IP Address is ");
  Serial.println(gprs.getIPAddress());

  if (!gprs.connect(TCP, "184.106.153.149", 80)) {
    Serial.println("connect error");
  } else {
    Serial.println("connect 184.106.153.149 success");
  }

  Serial.println("waiting to fetch...");


  value_temp = analogRead(A0);
  value_light = analogRead(A1);
  value_humid = analogRead(A2);
  String T = String(value_temp); // turn integer to string
  String L = String(value_light); // turn integer to string
  String H = String(value_humid); // turn integer to string

  Serial.print(T);
  Serial.print(L);
  Serial.println(H);
  String cmd = "GET /update?key=22TIOV8LXVYMAKX6&field1=" + T + "&field2=" + L + "&field3=" + H + "HTTP/1.0\r\n\r\n";
  char http_cmd[cmd.length() + 1];
  cmd.toCharArray(http_cmd, cmd.length() + 1);
  //= "GET /update?key=22TIOV8LXVYMAKX6&field1=591&field2=582&field3=590 HTTP/1.0\r\n\r\n";

  gprs.send(http_cmd, sizeof(http_cmd) - 1);


  while (true) {
    int ret = gprs.recv(buffer, sizeof(buffer) - 1);
    if (ret <= 0) {
      Serial.println("fetch over...");
      break;
    }
    buffer[ret] = '\0';
    Serial.print("Recv: ");
    Serial.print(ret);
    Serial.print(" bytes: ");
    Serial.println(buffer);
  }
  gprs.close();
  gprs.disconnect();

  delay(10000);

}
